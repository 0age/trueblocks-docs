---
title: "Recipe: Getting Erc20 Transfer Events"
description: "A method to extract ERC 20 Transfer events from a smart contract"
lead: "How many Transfers?"
date: 2021-04-13T08:00:02-04:00
lastmod: 2021-04-13T08:00:02-04:00
draft: false
weight: 50
images: ["getting-erc20-transfer-events.jpg"]
contributors: [Thomas Jay Rush]
---

A simple recipe to display every Transfer event from an ERC 20 contract using command line tools.

**Note:** The following assumes you have either built yourself or downloaded the TrueBlocks index of appearances. It also assumes that the address you're using is indeed an ERC 20 contract.

## Preliminaries

First, we want to query the index and make a list of every transaction that this address has ever been involved with.

```[bash]
chifra list 0x03fdcadc09559262f40f5ea61c720278264eb1da
```

This query reports that there were 2,129 appearances (at the time of this writing) of this address anywhere on the chain. This is more appearances than you will find if you query all four of the EtherScan APIs and subsequently remove duplicates. There's a reason for this that we won't go into.

Next, we can export the transactions to the screen (just so we can see that things are working).

```[bash]
chifra export --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da
```

The above command generates the same 2,129 records, but now with the details of the transactions.

**Note:** The `list` option gets called automatically if you simply run `export` on a new address. We are showing it here only to make this issue clear.

The `--fmt` option may be used to export data in any of three formats: `txt`, `csv` or `json`. We'll intersperse these options below.

Let's see what happens if we export the events generated during these 2,129 transactions.

## Focusing on Events / Logs

```[bash]
chifra export --fmt csv --logs 0x03fdcadc09559262f40f5ea61c720278264eb1da
```

This takes a bit longer and generates 8,100 records.

**Question:** Why is that?

**Answer:** Many transactions generate more than a single event.

**Question:** Is it possible to speed this step up?

**Answer:** Yes. Add the `--cache_txs` option to any export command to put the result in the TrueBlocks cache. Speed things up 20 to 30 times over querying the node directly.

## Articulating

Before we move on, we'll add in another option called `--articulate`.

The `--articulate` option turns "ugly blockchain data into human-readable text". (Try the command above both with and without `--articulate` to see the difference.)

## Filtering the Results

The above command generates 8,100 log entries. This includes every event *of any type* that our address had *anything* to do with. That is, this includes any event generated by any smart contract where this address appears.

We're going to briefly switch to `json` output in order to look more deeply. `JSON` format shows all the data, whereas `txt` and `csv` show only selected fields.

The next command extracts the addresses of the contracts that emitted any of those 8,100 events:

```[bash]
chifra export --logs --articulate --fmt json 0x03fdcadc09559262f40f5ea61c720278264eb1da | grep -i address
```

This is shows all the smart contracts that emitted an event in which our address appears. 'Appears' means our address generated (emitted) the event or it shows up in an event emitted by some other contract.

We want to try to limit the data to include only those events *emitted* by our smart contract.

We do this by including the `--emitter` option.

```[bash]
chifra export --logs --articulate --emitter --fmt json 0x03fdcadc09559262f40f5ea61c720278264eb1da | grep -i address
```

And now, we see only our address as the emitter addresses. If we remove the `grep` and return to using `csv`:

```[bash]
chifra export --logs --articulate --emitter --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da
```

we now only see 3,317 events (again, at the time of this writing).

## The Linux Philosophy

Following the linux philosphy of stringing together a data pipeline...

First, let's look at the first line of the data in order to see the names of the data fields:

```[bash]
chifra export --logs --articulate --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da | head -1
```

This produces

```[csv]
"blocknumber","transactionindex","logindex","address","topic0","topic1","topic2","topic3","data","type","compressedlog"
```

We are interested in the `blockNumber`, `transactionIndex`, and `compressLog` fields, so we use the Linux command `cut` to extract these columns:

```[bash]
chifra export --logs --articulate --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da | cut -d, -f1,2,11-100
```

And now we're starting to get somewhere.

Before we proceed, notice that we can build a histogram of the generated events thus:

```[bash]
chifra export --logs --articulate --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da | tr '"' ' ' | cut -d',' -f11-100 | cut -d'(' -f1 | sort | uniq -c | sort -n -r
```

Which produces the following table:

| Count |       Event      |
|-------|------------------|
|  3135 | Transfer         |
|  1325 | Sync             |
|  1214 | Swap             |
|  1075 | Approval         |
|   485 | Deposit          |
|   350 | Withdrawal       |
|   272 | Claimed          |
|    90 | Mint             |
|    84 | Staked           |
|    42 | Withdrawn        |
|    21 | Burn             |
|     6 | Sent             |
|     5 | RoleGranted      |
|     2 | TransferSingle   |
|     2 | RoleAdminChanged |
|     1 | Trade            |
|     1 | PairCreated      |
|     1 | OrderPlaced      |
|     1 | Fill             |
|     1 | EthPurchase      |

## How Many Transfers?

And finally, we get what we're after. A list of all `Transfers` events emitted by this address:

```[bash]
chifra export --logs --articulate --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da | tr '"' ' ' | cut -d',' -f1,2,11-100 | grep Transfer
```

And how many?

```[bash]
chifra export --logs --articulate --fmt csv 0x03fdcadc09559262f40f5ea61c720278264eb1da | tr '"' ' ' | cut -d',' -f1,2,11-100 | grep Transfer | wc
```

You figure it out!

## A Note on Using the API

You can do the same exact analysis with the `chifra serve` API.

First, understand that the entire API route structure exactly mirrors the command line options. For every tool, you may type `&lt;tool name&gt; --help` to get a list of options. You may attach these options to your `curl` command following the name of the tool (the route) to enable that option.

For example, the above final result could be written thus:

```[bash]
curl "http://localhost:8545/export?addrs=0x03fdcadc09559262f40f5ea61c720278264eb1da&logs&articulate&fmt=csv&max_records=10000"  | tr '"' ' ' | cut -d',' -f1,2,11-100 | grep Transfer | wc
```

Two changes: (1) preceed the address with `addrs` and (2) add `max_records=10000` as the API only returns 250 records by default.

Note that the API produces `json` data by default. You must include the `fmt=csv` option to your curl command if you want to pipe through command line tools (unless you use `jq` a highly recommended json parser/data wrangler).

We'll write about this later.
